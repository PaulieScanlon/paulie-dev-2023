<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="/prism-dracula.css" rel="stylesheet"><title>Paul Scanlon | Getting Started With CockroachDB, pg-promise and Next.js</title><link rel="canonical" href="https://paulie.dev/posts/2023/02/getting-started-with-cockroachdb-pg-promise-and-nextjs/"><meta name="description" content=""><meta name="image" content="https://paulie.devhttps://res.cloudinary.com/www-paulie-dev/image/upload/v1677502114/paulie.dev/2023/02/open-graph-image_qkecxd.jpg"><meta name="image:alt" content=""><meta name="keywords" content="React, Gatsby, JavaScript, TypeScript, Flow, Styled Components, Theme UI, Tailwind, Jest, Enzyme, React Testing Libary, Node.js, Fauna, Jamstack, Component Library, Serverless Functions"><!-- Facebook --><meta property="og:type"><meta property="og:title" content="Paul Scanlon | Getting Started With CockroachDB, pg-promise and Next.js"><meta property="og:url" content="https://paulie.dev/posts/2023/02/getting-started-with-cockroachdb-pg-promise-and-nextjs/"><meta property="og:description" content=""><meta property="og:image" content="https://paulie.devhttps://res.cloudinary.com/www-paulie-dev/image/upload/v1677502114/paulie.dev/2023/02/open-graph-image_qkecxd.jpg"><meta property="og:image:alt" content=""><!-- Twitter --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Paul Scanlon | Getting Started With CockroachDB, pg-promise and Next.js"><meta name="twitter:url" content="https://paulie.dev/posts/2023/02/getting-started-with-cockroachdb-pg-promise-and-nextjs/"><meta name="twitter:description" content=""><meta name="twitter:image" content="https://paulie.devhttps://res.cloudinary.com/www-paulie-dev/image/upload/v1677502114/paulie.dev/2023/02/open-graph-image_qkecxd.jpg"><meta name="twitter:image:alt" content=""><!-- Favicons --><link rel="icon" type="image/x-icon" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-react-helmet="true"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" data-react-helmet="true"><!-- Web mention --><link rel="webmention" href="https://webmention.io/paulie.dev/webmention"><link rel="pingback" href="https://webmention.io/paulie.dev/xmlrpc"><!-- <style type='text/css'>
      lite-youtube {
        border: 1px solid red !important;
      }
    </style> --><link rel="stylesheet" href="/_astro/about.3f802ac7.css" /><script type="module" src="/_astro/hoisted.5a594899.js"></script><style type="text/css">.twitter-tweet:not(.twitter-tweet-rendered){padding:var(--tc-padding, 1em);border:1px solid var(--tc-border-color, #cfd9de)}.twitter-tweet:not(.twitter-tweet-rendered)>:first-child{margin-top:0}.twitter-tweet:not(.twitter-tweet-rendered)>:last-child{margin-bottom:0}
</style><style type="text/css">lite-vimeo{font-size:10px;background-color:#000;position:relative;display:block;contain:content;background-position:center center;background-size:cover;cursor:pointer}lite-vimeo:after{content:"";display:block;padding-bottom:56.25%}lite-vimeo>iframe{width:100%;height:100%;position:absolute;top:0;left:0}lite-vimeo>.ltv-playbtn{width:6.5em;height:4em;background:rgba(23,35,34,.75);z-index:1;opacity:.8;border-radius:.5em;transition:all .2s cubic-bezier(0,0,.2,1);outline:0;border:0;cursor:pointer}lite-vimeo:hover>.ltv-playbtn{background-color:#00adef;background-color:var(--ltv-color, rgb(0, 173, 239));opacity:1}lite-vimeo>.ltv-playbtn:before{content:"";border-style:solid;border-width:10px 0 10px 20px;border-color:transparent transparent transparent #fff}lite-vimeo>.ltv-playbtn,lite-vimeo>.ltv-playbtn:before{position:absolute;top:50%;left:50%;transform:translate3d(-50%,-50%,0)}lite-vimeo.ltv-activated{cursor:unset}lite-vimeo.ltv-activated:before,lite-vimeo.ltv-activated>.ltv-playbtn{opacity:0;pointer-events:none}
</style><style type="text/css">lite-youtube{background-color:#000;position:relative;display:block;contain:content;background-position:center center;background-size:cover;cursor:pointer;max-width:720px}lite-youtube:before{content:"";display:block;position:absolute;top:0;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAADGCAYAAAAT+OqFAAAAdklEQVQoz42QQQ7AIAgEF/T/D+kbq/RWAlnQyyazA4aoAB4FsBSA/bFjuF1EOL7VbrIrBuusmrt4ZZORfb6ehbWdnRHEIiITaEUKa5EJqUakRSaEYBJSCY2dEstQY7AuxahwXFrvZmWl2rh4JZ07z9dLtesfNj5q0FU3A5ObbwAAAABJRU5ErkJggg==);background-position:top;background-repeat:repeat-x;height:60px;padding-bottom:50px;width:100%;transition:all .2s cubic-bezier(0,0,.2,1)}lite-youtube:after{content:"";display:block;padding-bottom:56.25%}lite-youtube>iframe{width:100%;height:100%;position:absolute;top:0;left:0;border:0}lite-youtube>.lty-playbtn{width:68px;height:48px;position:absolute;cursor:pointer;transform:translate3d(-50%,-50%,0);top:50%;left:50%;z-index:1;background-color:transparent;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 68 48"><path fill="%23f00" fill-opacity="0.8" d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z"></path><path d="M 45,24 27,14 27,34" fill="%23fff"></path></svg>');filter:grayscale(100%);transition:filter .1s cubic-bezier(0,0,.2,1);border:none}lite-youtube:hover>.lty-playbtn,lite-youtube .lty-playbtn:focus{filter:none}lite-youtube.lyt-activated{cursor:unset}lite-youtube.lyt-activated:before,lite-youtube.lyt-activated>.lty-playbtn{opacity:0;pointer-events:none}.lyt-visually-hidden{clip:rect(0 0 0 0);-webkit-clip-path:inset(50%);clip-path:inset(50%);height:1px;overflow:hidden;position:absolute;white-space:nowrap;width:1px}
</style><script src="/_astro/Tweet.astro_astro_type_script_index_0_lang.4828da08.js" type="module"></script><script src="/_astro/Vimeo.astro_astro_type_script_index_0_lang.9174df0e.js" type="module"></script><script src="/_astro/YouTube.astro_astro_type_script_index_0_lang.33baca9c.js" type="module"></script></head><body class="prose max-w-none bg-brand-background"><header class="sticky top-0 z-40 w-full backdrop-blur border-b border-b-brand-outline flex-none bg-brand-background lg:bg-transparent"><div class="max-w-8xl mx-auto"><div class="py-4 mx-4 lg:px-8 lg:mx-0"><div class="relative flex items-center"><a class="flex items-center" href="/" aria-current="page"><span class="sr-only">Paul Scanlon's Site</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 202 48" height="40"><g><circle class="fill-brand-background" cx="23" cy="24" r="23"></circle><path class="fill-brand-tertiary" d="M5,24c0-9.9,8.1-18,18-18l0,0V1C17.2,1,12.3,2.9,7.9,6.6C-1.7,15-2.7,29.5,5.6,39.1l3.8-3.3
          C6.7,32.6,5,28.5,5,24z"></path><path class="fill-brand-secondary" d="M23,42c-5.4,0-10.3-2.4-13.6-6.2l-3.8,3.3c0.8,0.9,1.7,1.8,2.6,2.5c9.7,8.2,24.2,6.9,32.4-2.8l-3.8-3.2
          C33.5,39.5,28.5,42,23,42z"></path><path class="fill-brand-primary" d="M23,1v5c9.9,0,18,8.1,18,18c0,4.4-1.6,8.4-4.2,11.6l3.8,3.2c3.7-4.4,5.4-9,5.4-14.8C46,11.3,35.7,1,23,1z"></path><path class="fill-brand-text" d="M18.9,16.9H24c1.1,0,2.1,0.2,2.8,0.6s1.3,0.9,1.7,1.6s0.5,1.4,0.5,2.3s-0.2,1.6-0.5,2.3s-0.9,1.2-1.6,1.6
          s-1.7,0.6-2.8,0.6h-2.4v6h-2.7V16.9z M23.9,23.5c0.8,0,1.4-0.2,1.8-0.6s0.6-0.9,0.6-1.5c0-0.7-0.2-1.2-0.6-1.6s-1-0.6-1.7-0.6
          h-2.3v4.2H23.9z"></path></g><g><path class="fill-brand-text" d="M60.3,17.9h5.1c1.1,0,2.1,0.2,2.8,0.6s1.3,0.9,1.7,1.6s0.5,1.4,0.5,2.3s-0.2,1.6-0.5,2.3s-0.9,1.2-1.6,1.6
          s-1.7,0.6-2.8,0.6h-2.4v6h-2.7V17.9z M65.3,24.5c0.8,0,1.4-0.2,1.8-0.6s0.6-0.9,0.6-1.5c0-0.7-0.2-1.2-0.6-1.6s-1-0.6-1.7-0.6
          h-2.3v4.2H65.3z"></path><path class="fill-brand-text" d="M80.4,22.4c0.9,0.7,1.3,1.9,1.3,3.6v6.8h-2.6v-1c-0.4,0.4-0.9,0.7-1.6,1s-1.3,0.3-2,0.3
          c-1.2,0-2.1-0.3-2.7-0.9c-0.6-0.6-0.9-1.4-0.9-2.3c0-0.8,0.3-1.5,0.8-2s1.2-1,2.2-1.3s2.1-0.4,3.4-0.4h0.8c-0.1-1-0.3-1.7-0.7-2.1
          s-1-0.6-1.8-0.6c-0.5,0-1.1,0.1-1.6,0.4s-1.1,0.6-1.5,1.1l-1.4-1.8c0.7-0.6,1.5-1.1,2.3-1.5s1.6-0.5,2.4-0.5
          C78.4,21.3,79.5,21.7,80.4,22.4z M78.4,30.3c0.5-0.5,0.7-1.3,0.8-2.4h-0.5c-1.4,0-2.4,0.1-3,0.4s-0.9,0.8-0.9,1.4
          c0,0.4,0.2,0.8,0.5,1s0.8,0.3,1.3,0.3C77.3,31.1,78,30.8,78.4,30.3z"></path><path class="fill-brand-text" d="M85.3,32.2c-0.6-0.7-1-1.9-1-3.6v-7H87v7c0,0.8,0.1,1.5,0.4,1.9s0.7,0.6,1.2,0.6c0.4,0,0.9-0.1,1.2-0.4
          s0.7-0.6,0.9-1s0.3-0.9,0.3-1.4v-6.7h2.7V31c0,0.5,0,0.8,0,1.1c0,0.2,0.1,0.5,0.2,0.7h-2.6c-0.1-0.2-0.2-0.4-0.2-0.6s0-0.4,0-0.7
          c-0.3,0.5-0.8,1-1.3,1.3s-1.1,0.5-1.7,0.5C86.9,33.3,86,33,85.3,32.2z"></path><path class="fill-brand-text" d="M96.8,32.9v-2.1h3.1v-12h-2.9v-2.1h5.6v14.1h3v2.1H96.8z"></path><path class="fill-brand-text" d="M128.6,25.6c0.6,0.4,1,0.9,1.2,1.4s0.4,1.1,0.4,1.7c0,0.8-0.2,1.5-0.6,2.2s-0.9,1.3-1.7,1.7
          s-1.8,0.6-3,0.6c-1.9,0-3.6-0.7-5.1-2.1l1.2-2l0,0l0,0c1.2,1.2,2.5,1.8,4.1,1.8c0.8,0,1.3-0.2,1.7-0.5s0.6-0.9,0.6-1.6
          c0-0.4-0.1-0.7-0.3-1s-0.5-0.6-0.9-0.9s-1-0.6-1.8-0.9c-1.4-0.6-2.4-1.3-3-2s-0.9-1.6-0.9-2.6c0-0.7,0.2-1.4,0.6-2s1-1.1,1.7-1.4
          s1.5-0.5,2.4-0.5c1,0,1.8,0.2,2.6,0.5s1.4,0.8,2.1,1.5l-1.3,1.9l0,0c0,0,0,0,0,0c-0.4-0.6-0.8-1-1.4-1.3s-1.2-0.4-1.9-0.4
          c-0.4,0-0.8,0.1-1.1,0.2s-0.6,0.4-0.7,0.6s-0.2,0.5-0.2,0.8c0,0.4,0.1,0.7,0.3,0.9s0.5,0.5,0.9,0.8s1.1,0.6,1.9,1
          C127.3,24.7,128.1,25.1,128.6,25.6z M120.9,29C120.9,29,120.9,29,120.9,29l0.1,0l0,0.1C120.9,29.1,120.9,29,120.9,29z M121.3,29.2
          C121.3,29.2,121.3,29.2,121.3,29.2c0,0-0.1,0-0.1,0s-0.1-0.1-0.1-0.1l0-0.1L121.3,29.2L121.3,29.2z M128.2,21.4
          C128.2,21.4,128.2,21.4,128.2,21.4c0,0,0.1,0,0.1,0s0.1,0.1,0.1,0.1l0,0.1L128.2,21.4L128.2,21.4z M128.6,21.6
          C128.6,21.6,128.6,21.6,128.6,21.6c0,0-0.1,0-0.2-0.1l0.1-0.1C128.5,21.5,128.6,21.6,128.6,21.6z"></path><path class="fill-brand-text" d="M139.2,30.6c0.5-0.2,0.9-0.6,1.4-1.1l1.6,1.8c-0.6,0.7-1.3,1.2-2,1.5s-1.5,0.5-2.4,0.5
          c-1.1,0-2.1-0.3-2.9-0.8c-0.9-0.5-1.5-1.2-2-2.1s-0.7-1.9-0.7-3c0-1.1,0.2-2.1,0.7-3s1.2-1.6,2-2.1s1.8-0.8,2.9-0.8
          c0.9,0,1.8,0.2,2.6,0.6s1.4,0.9,1.9,1.6l-1.5,1.8l0,0c0,0,0,0,0,0c-0.3-0.6-0.7-1-1.2-1.3s-1.1-0.4-1.8-0.4c-0.5,0-1,0.2-1.5,0.5
          s-0.8,0.8-1.1,1.3s-0.4,1.2-0.4,2c0,0.7,0.1,1.3,0.4,1.9s0.6,0.9,1,1.2s1,0.4,1.5,0.4C138.2,30.9,138.7,30.8,139.2,30.6z
           M140.4,25.3C140.4,25.3,140.4,25.3,140.4,25.3c0.1,0,0.1,0,0.3,0.1l0,0.1L140.4,25.3L140.4,25.3z M140.8,25.5
          C140.8,25.5,140.8,25.5,140.8,25.5c0,0-0.1,0-0.1-0.1l0.1-0.1C140.8,25.4,140.8,25.5,140.8,25.5z"></path><path class="fill-brand-text" d="M152.4,22.4c0.9,0.7,1.3,1.9,1.3,3.6v6.8h-2.6v-1c-0.4,0.4-0.9,0.7-1.6,1s-1.3,0.3-2,0.3
          c-1.2,0-2.1-0.3-2.7-0.9c-0.6-0.6-0.9-1.4-0.9-2.3c0-0.8,0.3-1.5,0.8-2s1.2-1,2.2-1.3s2.1-0.4,3.4-0.4h0.8c-0.1-1-0.3-1.7-0.7-2.1
          s-1-0.6-1.8-0.6c-0.5,0-1.1,0.1-1.6,0.4s-1.1,0.6-1.5,1.1l-1.4-1.8c0.7-0.6,1.5-1.1,2.3-1.5s1.6-0.5,2.4-0.5
          C150.4,21.3,151.5,21.7,152.4,22.4z M150.4,30.3c0.5-0.5,0.7-1.3,0.8-2.4h-0.5c-1.4,0-2.4,0.1-3,0.4s-0.9,0.8-0.9,1.4
          c0,0.4,0.2,0.8,0.5,1s0.8,0.3,1.3,0.3C149.3,31.1,150,30.8,150.4,30.3z"></path><path class="fill-brand-text" d="M156.6,21.7h2.7v1.1c0.4-0.4,0.9-0.8,1.4-1s1.1-0.4,1.8-0.4c1.1,0,1.9,0.4,2.5,1.1s1,1.9,1,3.5v6.8h-2.7
          v-6.8c0-0.8-0.2-1.5-0.5-1.9s-0.8-0.6-1.4-0.6c-0.4,0-0.7,0.1-1.1,0.2s-0.6,0.4-0.8,0.7s-0.3,0.7-0.3,1.1v7.2h-2.7V21.7z"></path><path class="fill-brand-text" d="M168.8,32.9v-2.1h3.1v-12h-2.9v-2.1h5.6v14.1h3v2.1H168.8z"></path><path class="fill-brand-text" d="M182.5,32.5c-0.8-0.5-1.5-1.2-1.9-2.1s-0.7-1.9-0.7-3.1c0-1.1,0.2-2.1,0.7-3s1.1-1.6,1.9-2.1
          s1.7-0.8,2.7-0.8s1.9,0.3,2.7,0.8s1.5,1.2,1.9,2.1s0.7,1.9,0.7,3c0,1.2-0.2,2.2-0.7,3.1s-1.1,1.6-1.9,2.1
          c-0.8,0.5-1.7,0.8-2.7,0.8S183.3,33,182.5,32.5z M186.6,30.6c0.4-0.3,0.7-0.8,0.9-1.3s0.3-1.2,0.3-2c0-0.8-0.1-1.4-0.3-2
          s-0.5-1-0.9-1.3s-0.9-0.4-1.4-0.4c-0.5,0-1,0.1-1.3,0.4s-0.7,0.7-0.9,1.3s-0.3,1.2-0.3,2c0,0.8,0.1,1.4,0.3,2s0.5,1,0.9,1.3
          s0.8,0.5,1.4,0.5S186.2,30.9,186.6,30.6z"></path><path class="fill-brand-text" d="M192.6,21.7h2.7v1.1c0.4-0.4,0.9-0.8,1.4-1s1.1-0.4,1.8-0.4c1.1,0,1.9,0.4,2.5,1.1s1,1.9,1,3.5v6.8h-2.7
          v-6.8c0-0.8-0.2-1.5-0.5-1.9s-0.8-0.6-1.4-0.6c-0.4,0-0.7,0.1-1.1,0.2s-0.6,0.4-0.8,0.7s-0.3,0.7-0.3,1.1v7.2h-2.7V21.7z"></path></g></svg></a><div class="relative flex lg:hidden items-center ml-auto"><button id="menu" class="not-prose ml-auto flex items-center justify-center text-brand-text"><span class="sr-only">Navigation</span><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path id="path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></button></div></div></div></div></header><div class="relative"><div id="lightbox" aria-label="lightbox" tab-index="0" role="button" class="z-20 top-0 left-0 w-screen h-screen bg-black opacity-80"></div><div class="max-w-8xl mx-auto px-4 sm:px-6 md:px-8"><div id="sidebar" class="lg:block fixed z-30 inset-0 top-[3.8125rem] transition-all duration-300 right-auto w-[14.5rem] pb-10 px-6 overflow-y-auto border-r border-r-brand-outline bg-brand-background lg:left-[max(0px,calc(50%-45rem))]"><div class="pt-10 pb-4"></div><div class="relative"><ul class="flex flex-col gap-2 m-0 p-0"><li class="m-0 p-0 list-none"><a href="/" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 hover:text-brand-text text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z"></path></svg>Home</a></li><li class="m-0 p-0 list-none"><a href="/about/" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 hover:text-brand-text text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"></path></svg>About</a></li><li class="m-0 p-0 list-none"><a href="/articles/" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 hover:text-brand-text text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.566 4.657A4.505 4.505 0 016.75 4.5h10.5c.41 0 .806.055 1.183.157A3 3 0 0015.75 3h-7.5a3 3 0 00-2.684 1.657zM2.25 12a3 3 0 013-3h13.5a3 3 0 013 3v6a3 3 0 01-3 3H5.25a3 3 0 01-3-3v-6zM5.25 7.5c-.41 0-.806.055-1.184.157A3 3 0 016.75 6h10.5a3 3 0 012.683 1.657A4.505 4.505 0 0018.75 7.5H5.25z"></path></svg>Articles</a></li><li class="m-0 p-0 list-none"><a href="/demos/" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 hover:text-brand-text text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006"></path></svg>Demos</a></li><li class="m-0 p-0 list-none"><a href="/opensource/" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 hover:text-brand-text text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 5.337c0-.355-.186-.676-.401-.959a1.647 1.647 0 01-.349-1.003c0-1.036 1.007-1.875 2.25-1.875S15 2.34 15 3.375c0 .369-.128.713-.349 1.003-.215.283-.401.604-.401.959 0 .332.278.598.61.578 1.91-.114 3.79-.342 5.632-.676a.75.75 0 01.878.645 49.17 49.17 0 01.376 5.452.657.657 0 01-.66.664c-.354 0-.675-.186-.958-.401a1.647 1.647 0 00-1.003-.349c-1.035 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401.31 0 .557.262.534.571a48.774 48.774 0 01-.595 4.845.75.75 0 01-.61.61c-1.82.317-3.673.533-5.555.642a.58.58 0 01-.611-.581c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.035-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959a.641.641 0 01-.658.643 49.118 49.118 0 01-4.708-.36.75.75 0 01-.645-.878c.293-1.614.504-3.257.629-4.924A.53.53 0 005.337 15c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.036 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.369 0 .713.128 1.003.349.283.215.604.401.959.401a.656.656 0 00.659-.663 47.703 47.703 0 00-.31-4.82.75.75 0 01.83-.832c1.343.155 2.703.254 4.077.294a.64.64 0 00.657-.642z"></path></svg>Open-source</a></li><li class="m-0 p-0 list-none"><a href="/posts/" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 hover:text-brand-text text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32L19.513 8.2z"></path></svg>Posts</a></li><li class="m-0 p-0 list-none"><a href="/streams/" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 hover:text-brand-text text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 4.5a3 3 0 00-3 3v9a3 3 0 003 3h8.25a3 3 0 003-3v-9a3 3 0 00-3-3H4.5zM19.94 18.75l-2.69-2.69V7.94l2.69-2.69c.944-.945 2.56-.276 2.56 1.06v11.38c0 1.336-1.616 2.005-2.56 1.06z"></path></svg>Streams</a></li><li class="m-0 p-0 list-none"><a href="/dashboard/" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 hover:text-brand-text text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75zM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 01-1.875-1.875V8.625zM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 013 19.875v-6.75z"></path></svg>Dashboard</a></li></ul><hr class="border border-brand-outline my-8"><ul class="flex flex-col gap-2 m-0 p-0"><li class="m-0 p-0 list-none"><a href="https://x.com/PaulieScanlon" target="_blank" rel="noreferrer me" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 text-slate-400 hover:text-brand-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg>X</a></li><li class="m-0 p-0 list-none"><a href="https://github.com/PaulieScanlon" target="_blank" rel="noreferrer me" class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 text-slate-400 hover:text-brand-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.88,0.6C5.5,0.6,0.3,5.8,0.3,12.18c0,5.44,3.78,10.05,8.86,11.23c0-0.12-0.12-0.35-0.12-0.59V20.8c-0.47,0-1.3,0-1.42,0c-0.83,0-1.54-0.35-1.89-0.95c-0.35-0.71-0.47-1.77-1.42-2.48C4.08,17.14,4.2,16.9,4.55,16.9c0.59,0.12,1.06,0.59,1.54,1.18c0.47,0.59,0.71,0.71,1.54,0.71c0.47,0,1.06,0,1.65-0.12c0.35-0.83,0.83-1.54,1.54-1.89c-3.9-0.35-5.67-2.36-5.67-4.96c0-1.18,0.47-2.25,1.3-3.19c-0.35-0.59-0.71-2.48,0-3.19c1.77,0,2.84,1.18,3.07,1.42c0.83-0.35,1.77-0.47,2.84-0.47s2.01,0.12,2.84,0.47c0.24-0.35,1.3-1.42,3.07-1.42c0.71,0.71,0.35,2.6,0.12,3.55c0.83,0.95,1.3,2.01,1.3,3.07c0,2.6-1.89,4.49-5.67,4.96c1.06,0.59,1.89,2.13,1.89,3.31v2.6c0,0.12,0,0.12,0,0.24c4.49-1.54,7.8-5.91,7.8-10.99C23.46,5.8,18.26,0.6,11.88,0.6z"></path></svg>GitHub</a></li><li class="m-0 p-0 list-none"><a href="https://linkedin.com/in/PaulieScanlon" target="_blank" rel="noreferrer " class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 text-slate-400 hover:text-brand-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21.4,0.64H2.72c-1.14,0-2.02,0.88-2.02,2.02v18.55c0,1.26,0.88,2.15,2.02,2.15h18.55c1.14,0,2.02-0.88,2.02-2.02V2.66C23.42,1.52,22.53,0.64,21.4,0.64z M7.89,19.19H4.86V9.48h3.03C7.89,9.48,7.89,19.19,7.89,19.19z M6.38,8.09c-1.01,0-1.77-0.76-1.77-1.77s0.76-1.89,1.77-1.89s1.77,0.76,1.77,1.77S7.26,8.09,6.38,8.09z M19.25,19.19h-3.03v-4.67c0-1.14,0-2.65-1.64-2.65s-1.77,1.26-1.77,2.52v4.8H9.79V9.48h2.9v1.26l0,0c0.38-0.76,1.39-1.64,2.9-1.64c3.03,0,3.66,2.02,3.66,4.67C19.25,13.89,19.25,19.19,19.25,19.19z"></path></svg>LinkedIn</a></li><li class="m-0 p-0 list-none"><a href="mailto:pauliescanlon@gmail.com" target="_blank" rel="noreferrer " class="not-prose inline-flex items-center gap-3 rounded-full px-3 py-2 border-transparent hover:bg-brand-surface border hover:border-brand-outline transition-colors duration-300 text-slate-400 hover:text-brand-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.35,3.18c-0.95,0-1.79,0.83-1.79,1.79v14.06c0,0.95,0.83,1.79,1.79,1.79h19.31c0.95,0,1.79-0.83,1.79-1.79V4.97c0-0.95-0.83-1.79-1.79-1.79h1.07H2.35z M4.73,4.97h14.54L12,10.33L4.73,4.97z M3.18,7.11L12,13.55l8.82-6.44v11.92H3.18V7.11z"></path></svg>Email</a></li></ul></div></div><main class="lg:pl-[14.5rem] pb-16"><section class="mx-auto pt-6 max-w-none xl:ml-0 xl:mr-[15.5rem] xl:pr-16"><article class="max-w-none min-h-[calc(100vh-19rem)]"><time class="text-xs font-bold text-brand-primary">Feb 24, 2023</time><h1>Getting Started With CockroachDB, pg-promise and Next.js</h1><p>In this guide you should find everything you need to get started with
<a href="https://www.cockroachlabs.com/product/">CockroachDB</a>, <a href="https://github.com/vitaly-t/pg-promise">pg-promise</a> and
<a href="https://nextjs.org/">Next.js</a> (API Routes). But, before I dive in I’d like to explain my “why”.</p>
<astro-embed-tweet><blockquote class="twitter-tweet" data-dnt="true"><p lang="en" dir="ltr">This article by <a href="https://twitter.com/PaulieScanlon?ref_src=twsrc%5Etfw">@PaulieScanlon</a> is a couple of months old but it’s so well written that I had to include it<a href="https://t.co/X1jYk84xji">https://t.co/X1jYk84xji</a></p>&mdash; Erfan Ebrahimnia (@ErfanEbrahimnia) <a href="https://twitter.com/ErfanEbrahimnia/status/1654843780162371584?ref_src=twsrc%5Etfw">May 6, 2023</a></blockquote>
</astro-embed-tweet>
<h2 id="getting-started-resources">Getting Started Resources</h2>
<p><a href="https://www.cockroachlabs.com/">Cockroach Labs</a> have a number of ways to help you get going, and depending on where you
are with you learning journey and the technology you’re familiar with, you can chose where to start.</p>
<ol>
<li><a href="https://www.cockroachlabs.com/cockroach-university/">Cockroach University</a></li>
<li><a href="https://www.cockroachlabs.com/docs/stable/build-a-nodejs-app-with-cockroachdb.html">Build a Simple CRUD Node.js App with CockroachDB and the node-postgres Driver</a></li>
<li><a href="https://www.cockroachlabs.com/docs/stable/deploy-app-vercel.html">Deploy a Web App Built on CockroachDB with Vercel</a></li>
</ol>
<p>Unfortunately for me none of the above suited my needs. The sample app I’ve created for this guide however, does.</p>
<p>If you’re keen to jump ahead you can see the sample app and code on the links below.</p>
<ul>
<li>🚀 Live Preview:
<a href="https://cockroachdb-pg-promise-nextjs.vercel.app/">https://cockroachdb-pg-promise-nextjs.vercel.app/</a></li>
<li>⚙️ Repository:
<a href="https://github.com/PaulieScanlon/cockroachdb-pg-promise-nextjs">https://github.com/PaulieScanlon/cockroachdb-pg-promise-nextjs</a></li>
</ul>
<h2 id="modern-frontends">Modern FrontEnds</h2>
<p>You probably know this already but, in the “Jamstack”, the lines between frontend and the server are somewhat blurred,
and the concept of building a web application that has a frontend and a separate node.js server are becoming a thing of
the past.</p>
<p>Using a framework like <a href="https://nextjs.org/">Next.js</a> <em>(there are many others)</em> you can develop your frontend code
alongside your server-side code in the same project. In cases when using
<a href="https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props">Next.js getServerSideProps</a>, you’ll not
only develop your server-side code in the same project, you’ll develop your server-side code in the same <em>page</em> as your
frontend code! Both together can be deployed to a single CDN like Vercel.</p>
<p>Because of this shift I’ve written this guide to help you get started with
<a href="https://www.cockroachlabs.com/product/">CockroachDB</a> in the Jamstack era.</p>
<h3 id="sql--pg-promise">SQL / pg-promise</h3>
<p>In my opinion, <a href="https://node-postgres.com/">node-postgres</a> and <a href="https://github.com/vitaly-t/pg-promise">pg-promise</a> are
the closest you can get to writing SQL in a node.js environment. In this post I’ll be using pg-promise.</p>
<p>There are JavaScript abstractions like <a href="https://www.prisma.io/">Prisma</a> which will allow you to interact with an SQL
database from a node.js environment but, by using Prisma you’ll be writing Prisma specific JavaScript syntax rather than
SQL.</p>
<h3 id="cockroach-sql">cockroach sql</h3>
<p>There’s one other “tool” I think you’ll want to be aware of called
<a href="https://www.cockroachlabs.com/docs/stable/cockroach-sql.html">cockroach sql</a>. I’ve found this to be super helpful for
initial setup of tables and having a quick look at whats in the database. I haven’t really been using it to <strong>query</strong>
specific data or <strong>mutate</strong> data stored within the database… that’s the bit
<a href="https://github.com/vitaly-t/pg-promise">pg-promise</a> will do through the app interface.</p>
<p>I’ll be using cockroach sql later in this guide so if you don’t have
<a href="https://www.cockroachlabs.com/docs/stable/cockroach-sql-binary.html#install-cockroach-sql">cockroach sql</a> installed, go
ahead and do that now.</p>
<h2 id="getting-started-with-cockroachdb">Getting Started With CockroachDB</h2>
<p>Before you do anything you’ll need a free CockroachDB account, <a href="https://cockroachlabs.cloud/signup">sign up</a> before
continuing.</p>
<h3 id="create-a-cockroachdb-cluster">Create a CockroachDB Cluster</h3>
<p>You should be looking at a page similar to the below. Click the <strong>Create Cluster</strong> button.</p>
<img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677231525/paulie.dev/2023/02/1-empty-cluster_yk1xuq.jpg" alt="Create a New Cluster" width="768" height="480" loading="lazy" decoding="async">
<h3 id="setup-a-cockroachdb-cluster---1">Setup a CockroachDB Cluster - 1</h3>
<p>For the purposes of this guide I’ll be using CockroachDB Serverless, select <strong>Severless</strong> and scroll down.</p>
<img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677231525/paulie.dev/2023/02/2-choose-serverless_soccaf.jpg" alt="Select Serverless Database" width="768" height="480" loading="lazy" decoding="async">
<h3 id="setup-a-cockroachdb-cluster---2">Setup a CockroachDB Cluster - 2</h3>
<p>CockroachDB is <em>cloud native</em>. CockroachDB can be deployed to Amazon Web Services (AWS) and Google Cloud Platform (GCP).</p>
<p>It’s not overly important at this stage of getting started to know why to chose one Cloud provider over the other but,
just for completeness, this is a super valuable feature of CockroachDB as it allows companies to avoid “vendor lock in”.</p>
<p>You can also select which regions you’d like your database deployed to. Generally speaking you’ll choose a region that
is close to your <a href="https://vercel.com/docs/concepts/functions/serverless-functions/regions">Serverless Function</a> region
and / or your users.</p>
<p>At present CockroachDB Serverless can only run in a single region. Multi-Region Serverless is launching soon so I’d
suggest you give <a href="https://twitter.com/CockroachDB">CockroachDB</a> a follow on Twitter so you don’t miss the launch.</p>
<p>Lastly, give your Cluster a name. <strong>Choose wisely as this can’t be changed later!</strong>. I’ve been prefixing the names with
either <strong>dev-</strong> or <strong>prod-</strong> so I can more easily switch between databases whilst developing. I’ll cover this later when
discussing
<a href="https://nextjs.org/docs/basic-features/environment-variables#environment-variable-load-order">Next.js environment variables</a>.</p>
<p>When you’re done, click the <strong>Create your free cluster</strong> button.</p>
<img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677231525/paulie.dev/2023/02/3-choose-provider-add-name_bdv9ij.jpg" alt="Selected Cloud Provider and give the database a name" width="768" height="480" loading="lazy" decoding="async">
<h3 id="create-sql-user---name">Create SQL User - name</h3>
<p>My name is Paul so I created a user called Paul 🤷. When you’ve entered an SQL user name click the <strong>Generate &amp; save
password</strong> button, and then click the <strong>Next</strong> button.</p>
<img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677231526/paulie.dev/2023/02/4-create-user-1_ndxl94.jpg" alt="Create or select an SQL user" width="768" height="480" loading="lazy" decoding="async">
<h3 id="create-sql-user---password">Create SQL User - password</h3>
<p>This step isn’t entirely required as the password can be revealed in the next step but, if you wanna be super safe, copy
the password and save it somewhere, then click the <strong>Next</strong> button when you’re ready.</p>
<img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677231526/paulie.dev/2023/02/5-create-user-2_pcq4pd.jpg" alt="Copy and save the password" width="768" height="480" loading="lazy" decoding="async">
<h3 id="create-sql-user---database_url">Create SQL User - DATABASE_URL</h3>
<p>There are a couple of options available via the various select inputs, for the purposes of this guide you can use the
options I’ve selected in the image below. These are:</p>
<ul>
<li>Database: <code>defaultdb</code></li>
<li>Select option/language: <code>JavasScript/TypeScript</code></li>
<li>Select tool: <code>node-postgres</code></li>
<li>Selection operating system: <code>(automatically detected)</code></li>
</ul>
<p>When you’re ready you can now copy the connection string and save it somewhere safe.</p>
<p>☝️ One thing to be aware of when using the <em>Copy</em> button 👇.</p>
<p>The connection string includes <code>export DATABASE_URL=&quot;...&quot;</code>. You won’t need the <code>export</code> bit. This is helpful for when
developing node.js applications and when run in a terminal will export the connection string to your terminal session,
but when you close your terminal window it’ll be gone.</p>
<p>When using Next.js you’ll be saving this variable in one of the <code>.env</code> files. More on that in moment.</p>
<p>Delete the word <code>export</code> and save the connection string somewhere safe. Here’s a diff.</p>
<pre class="language-diff"><code is:raw="" class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> export DATABASE_URL=&quot;...&quot;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> DATABASE_URL=&quot;...&quot;</span></span></code></pre>
<img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677231526/paulie.dev/2023/02/6-connect_n8px0y.jpg" alt="Copy and save the connection string" width="768" height="480" loading="lazy" decoding="async">
<h3 id="repeat-for-production">Repeat For Production</h3>
<p>As mentioned, I’ve been prefixing the Cluster name with <strong>dev-</strong> or <strong>prod-</strong>. Repeat the above steps and create a
second Cluster that will be used in production later when you deploy your Next.js app.</p>
<h3 id="cluster-overview">Cluster Overview</h3>
<p>You should now be looking at a page similar to the below. You probably won’t need to go back into the CockroachDB Cloud
Console but maybe bookmark the page just in case.</p>
<img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677231527/paulie.dev/2023/02/7-done_dgpsyv.jpg" alt="Finished configured Cluster" width="768" height="480" loading="lazy" decoding="async">
<h3 id="connecting-to-a-cluster-with-cockroach-sql">Connecting to a Cluster with cockroach sql</h3>
<p>It’s now time to test you can connect to your CockroachDB Cluster using cockroach sql.</p>
<p>Open a new terminal window and type the following. Paste your connecting string in between the quote marks, and don’t
forget the <code>;</code> at the end of the line. <strong>All statements must be terminated by a semicolon</strong>.</p>
<pre class="language-plaintext"><code is:raw="" class="language-plaintext">cockroach sql --url=&quot;&quot;;</code></pre>
<p>Full example</p>
<pre class="language-shell"><code is:raw="" class="language-shell">cockroach sql <span class="token parameter variable">--url</span><span class="token operator">=</span><span class="token string">&quot;postgresql://paul:&lt;ENTER-SQL-USER-PASSWORD&gt;@dev-test-db-6335.7tc.cockroachlabs.cloud:26257/defaultdb?sslmode=verify-full&quot;</span><span class="token punctuation">;</span></code></pre>
<p>If the connection was successful you should be seeing something similar to the below.</p>
<pre class="language-shell"><code is:raw="" class="language-shell"><span class="token comment"># Welcome to the CockroachDB SQL shell.</span>
<span class="token comment"># All statements must be terminated by a semicolon.</span>
<span class="token comment"># To exit, type: \q.</span>
<span class="token comment">#</span>
<span class="token comment"># Client version: CockroachDB CCL v22.2.4 (aarch64-apple-darwin21.2, built 2023/02/13 17:52:58, go1.19.4)</span>
<span class="token comment"># Server version: CockroachDB CCL v22.2.5 (x86_64-pc-linux-gnu, built 2023/02/16 16:23:05, go1.19.4)</span>
<span class="token comment"># Cluster ID: ddf31a83-ff79-4701-3dab-ffca12c6ea40</span>
<span class="token comment">#</span>
<span class="token comment"># Enter \? for a brief introduction.</span>
<span class="token comment">#</span>
paul@dev-test-db-6335.7tc.cockroachlabs.cloud:26257/defaultdb<span class="token operator">&gt;</span></code></pre>
<p><em>If you wish to escape cockroach sql at any time you can type the word <code>exit</code> and hit enter.</em></p>
<h3 id="creating-a-table-with-cockroach-sql">Creating a table with cockroach sql</h3>
<p>At this point you will have a Cluster and a database. To double check this, run the following in your terminal.
<em>(assuming the cockroach sql session is still running)</em></p>
<pre class="language-shell"><code is:raw="" class="language-shell">SHOW DATABASES<span class="token punctuation">;</span></code></pre>
<p>You should be looking at something similar to the below.</p>
<pre class="language-shell"><code is:raw="" class="language-shell">  database_name <span class="token operator">|</span> owner <span class="token operator">|</span> primary_region <span class="token operator">|</span> secondary_region <span class="token operator">|</span> regions <span class="token operator">|</span> survival_goal
----------------+-------+----------------+------------------+---------+----------------
  defaultdb     <span class="token operator">|</span> root  <span class="token operator">|</span> NULL           <span class="token operator">|</span> NULL             <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token operator">|</span> NULL
  postgres      <span class="token operator">|</span> root  <span class="token operator">|</span> NULL           <span class="token operator">|</span> NULL             <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token operator">|</span> NULL
  system        <span class="token operator">|</span> <span class="token function">node</span>  <span class="token operator">|</span> NULL           <span class="token operator">|</span> NULL             <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token operator">|</span> NULL
<span class="token punctuation">(</span><span class="token number">3</span> rows<span class="token punctuation">)</span>
</code></pre>
<p>However, you’ll still need to create a table. You can see what I mean if you run the following in your terminal.</p>
<pre class="language-shell"><code is:raw="" class="language-shell">SHOW TABLES<span class="token punctuation">;</span></code></pre>
<p>Which will likely result in something similar to the below.</p>
<pre class="language-shell"><code is:raw="" class="language-shell">SHOW TABLES <span class="token number">0</span></code></pre>
<p>If you’re planning to use my sample app without modification you can create a table using the schema below.</p>
<p>Most of the data types used are standard <a href="https://www.sqltutorial.org/sql-data-types/">SQL data types</a> with the
exception of the <code>id</code>. Rather than using <code>AUTO_INCREMENT</code>, with CockroachDB you can use a helper function called
<code>gen_random_uuid</code>. You can read more about that in the docs here:
<a href="https://www.cockroachlabs.com/docs/stable/uuid.html">UUID</a></p>
<p>Run the following in your terminal to create a table called <code>locations</code>.</p>
<pre class="language-shell"><code is:raw="" class="language-shell">CREATE TABLE locations <span class="token punctuation">(</span>
  <span class="token function">id</span>       UUID DEFAULT gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span> PRIMARY KEY,
  <span class="token function">date</span>     DATE,
  city     VARCHAR,
  lat      DECIMAL,
  lng      DECIMAL,
  runtime  VARCHAR
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>To check the table was created correctly, run the following in your terminal.</p>
<pre class="language-shell"><code is:raw="" class="language-shell">SHOW TABLES<span class="token punctuation">;</span></code></pre>
<p>Which should result in something similar to the below.</p>
<pre class="language-shell"><code is:raw="" class="language-shell">  schema_name <span class="token operator">|</span> table_name <span class="token operator">|</span> <span class="token builtin class-name">type</span>  <span class="token operator">|</span> owner <span class="token operator">|</span> estimated_row_count <span class="token operator">|</span> locality
--------------+------------+-------+-------+---------------------+-----------
  public      <span class="token operator">|</span> locations  <span class="token operator">|</span> table <span class="token operator">|</span> paul  <span class="token operator">|</span>                   <span class="token number">0</span> <span class="token operator">|</span> NULL</code></pre>
<p>🎉 Your Cluster, database and table are now ready for some <a href="https://github.com/vitaly-t/pg-promise">pg-promise</a> action.
In the next steps I’ll take you through how to build the sample app using Next.js.</p>
<h2 id="getting-started-with-pg-promise-and-nextjs">Getting Started With pg-promise and Next.js</h2>
<p>I think I’m somewhat alone in my thinking when it comes to spinning up new “framework” projects. I’m not a fan of
running a command in the terminal and <em>bippity boppity boo</em> an application pops out. It’s faster for sure, but did you
learn anything?</p>
<p>My approach is deeply rooted in the age old fable of the
<a href="https://en.wikipedia.org/wiki/The_Tortoise_and_the_Hare">The Tortoise and the Hare</a>… and we all know who won that
race 🐢.</p>
<h3 id="create-an-empty-github-repository">Create an Empty GitHub Repository</h3>
<p>This is usually the first thing I’ll do when starting a new Next.js project.</p>
<img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677239295/paulie.dev/2023/02/8-create-github-repo-1_bcyjbo.jpg" alt="Create GitHub Repository" width="768" height="480" loading="lazy" decoding="async">
<p>I also like to select the <code>.gitignore</code> and <code>license</code> before cloning the repository to my local development environment,
these are.</p>
<ul>
<li>.gitignore: <code>Node</code></li>
<li>License: <code>MIT License</code></li>
</ul>
<img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677239295/paulie.dev/2023/02/8-create-github-repo-2_q0p9gp.jpg" alt="Create GitHub Repository" width="768" height="480" loading="lazy" decoding="async">
<p>If you’re following along, you’re now ready to clone the repo to you local development environment, E.g.</p>
<pre class="language-shell"><code is:raw="" class="language-shell"><span class="token function">git</span> clone https://github.com/PaulieScanlon/cockroachdb-pg-promise-nextjs.git</code></pre>
<p>Once you’ve cloned the repository you can change directory and move inside the project directory, E.g</p>
<pre class="language-shell"><code is:raw="" class="language-shell"><span class="token builtin class-name">cd</span> cockroachdb-pg-promise-nextjs</code></pre>
<p>If you’re in the correct directory you can create a default <code>package.json</code> by running the following command.</p>
<pre class="language-shell"><code is:raw="" class="language-shell"> <span class="token function">npm</span> init <span class="token parameter variable">-y</span></code></pre>
<h3 id="install-dependencies">Install Dependencies</h3>
<p>There’s x3 dependencies you’ll need to install to use Next.js, run the following in your terminal,</p>
<pre class="language-shell"><code is:raw="" class="language-shell"><span class="token function">npm</span> <span class="token function">install</span> next react react-dom <span class="token parameter variable">--save</span></code></pre>
<p>There’s also a couple more dependencies you’ll need to install to build my sample application. Run the following in your
terminal.</p>
<pre class="language-shell"><code is:raw="" class="language-shell"><span class="token function">npm</span> <span class="token function">install</span> pg-promise request-ip fast-geoip <span class="token parameter variable">--save</span>
</code></pre>
<h3 id="add-scripts">Add Scripts</h3>
<p>With the dependencies installed open up <code>package.json</code> and add the following to <code>&quot;scripts&quot;</code>. You can also see this
mentioned in the Next.js docs: <a href="https://nextjs.org/docs/getting-started#manual-setup">Manual Setup</a>.</p>
<pre class="language-diff"><code is:raw="" class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &quot;scripts&quot;: {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    &quot;dev&quot;: &quot;next dev&quot;,
</span><span class="token prefix inserted">+</span><span class="token line">    &quot;build&quot;: &quot;next build&quot;,
</span><span class="token prefix inserted">+</span><span class="token line">    &quot;start&quot;: &quot;next start&quot;,
</span><span class="token prefix inserted">+</span><span class="token line">    &quot;lint&quot;: &quot;next lint&quot;,
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
</span><span class="token prefix unchanged"> </span><span class="token line"> },
</span></span></code></pre>
<h3 id="environment-variables">Environment Variables</h3>
<p>There’s a few options in the Next.js docs for how to use environment variables here:
<a href="https://nextjs.org/docs/basic-features/environment-variables#default-environment-variables">Default Environment Variables </a></p>
<p>Go ahead and create the following at the root of your project.</p>
<ul>
<li><code>.env.production.local</code></li>
<li><code>.env.production.local</code></li>
</ul>
<p>☝️ Make sure you add the names of these environment variables to your <code>.gitignore</code>, somewhere around Line 80, E.g.</p>
<pre class="language-diff"><code is:raw="" class="language-diff"># Next.js build output
.next
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> .env.development.local
</span><span class="token prefix inserted">+</span><span class="token line"> .env.production.local</span></span></code></pre>
<p>Inside each of the <code>.env.</code> files you can add the connection string you copied earlier from the
<a href="#create-sql-user---database_url">Create SQL User - DATABASE_URL</a> step.</p>
<p>Here’s what my <code>.env.development.local</code> looks like. <em>(I’ve replaced the password with <code>123</code>)</em>.</p>
<pre class="language-shell"><code is:raw="" class="language-shell"><span class="token comment"># .env.development.local</span>

<span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span><span class="token string">&quot;postgresql://paul:123@dev-test-db-6335.7tc.cockroachlabs.cloud:26257/defaultdb?sslmode=verify-full&quot;</span></code></pre>
<p>You may wish to repeat this process for <code>.env.production.local</code> and use the connection string from the <strong>prod-</strong> Cluster
if you created one in the earlier step.</p>
<h3 id="pg-promise-config">pg-promise config</h3>
<p>I borrowed this setup from an issue on the <code>pg-promise</code> repo. You can see the issue here:
<a href="https://github.com/vitaly-t/pg-promise/issues/175">Question re: WARNING: Creating a duplicate database object for the same connection #175</a></p>
<p>The issue relates to using <code>pg-promise</code> in instances where the connection might be invoked more than once. In this
sample app you’ll be using the <code>client</code> function in both a server-side request using <code>getServerSideProps</code> and from
within a Serverless Function (API Routes). You only need to create the <code>pg-promise</code> database instance once. The
following singleton pattern prevents duplicates from being created when <code>client</code> is called using the different methods
in this sample app.</p>
<p>Create a directory at the root of you project called <code>db</code>. Inside this directory create a file called <code>index.js</code> and add
the following code snippet.</p>
<pre class="language-javascript"><code is:raw="" class="language-javascript"><span class="token comment">// ./db</span>

<span class="token keyword">import</span> pgPromise <span class="token keyword">from</span> <span class="token string">&#39;pg-promise&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pgp <span class="token operator">=</span> <span class="token function">pgPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">createSingleton</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> create</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> s <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> scope <span class="token operator">=</span> global<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scope <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    global<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">=</span> scope<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> scope<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">client</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">createSingleton</span><span class="token punctuation">(</span><span class="token string">&#39;my-app-db-space&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">pgp</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="create-a-page">Create A Page</h3>
<p>Create a directory at the root of your project called <code>pages</code>. Inside this directory create a file called <code>index.js</code> and
add the following code snippet.</p>
<p>In the steps further down you’ll be using two different ways to communicate with the database. To make this a little
easier to digest I’ve split the functionality into two different parts.</p>
<h4 id="query">Query</h4>
<p>When “reading” data from the database you’ll use <code>getServerSideProps</code>.</p>
<h4 id="mutation">Mutation</h4>
<p>When “inserting” date into or “deleting” data from the database you’ll be using Serverless Functions called from a
client side <code>fetch</code> request.</p>
<pre class="language-javascript"><code is:raw="" class="language-javascript"><span class="token comment">// pages/index.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> error <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>main style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> <span class="token string">&#39;system-ui&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Error<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>pre<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>pre<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>main<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>main style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> <span class="token string">&#39;system-ui&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Getting Started With CockroachDB<span class="token punctuation">,</span> pg<span class="token operator">-</span>promise and Next<span class="token punctuation">.</span>js<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>Insert<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Click submit to insert a <span class="token keyword">new</span> <span class="token class-name">location</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>Submit<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>Data<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>pre<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>pre<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>main<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getServerSideProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> client <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../db&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token string">&#39;SELECT * from locations&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">locations</span><span class="token operator">:</span> response<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> date<span class="token punctuation">,</span> city<span class="token punctuation">,</span> lat<span class="token punctuation">,</span> lng<span class="token punctuation">,</span> runtime <span class="token punctuation">}</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
              id<span class="token punctuation">,</span>
              <span class="token literal-property property">date</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              city<span class="token punctuation">,</span>
              lat<span class="token punctuation">,</span>
              lng<span class="token punctuation">,</span>
              runtime<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">error</span><span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Page<span class="token punctuation">;</span></code></pre>
<p>There’s quite a lot going on here so I’ll talk you through it.</p>
<p>Look for <code>getServerSideProps</code>. This function runs on the server and can be used to get data from the database. The
<code>require</code> and the destructured statement for <code>db</code> are the pg-promise you setup earlier. Using <code>db.</code> you can now use the
<a href="https://github.com/vitaly-t/pg-promise#methods">pg-promise methods</a> to communicate with the database.</p>
<p>In this page <code>db.any</code> is used within a try / catch statement to run a common SQL query, E.g.</p>
<pre class="language-sql"><code is:raw="" class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> locations</code></pre>
<p>This, as you might imagine, selects everything from the table called locations.</p>
<ul>
<li>If the response is successful it’s returned by <code>getServerSideProps</code> to the page and made available via the <code>data</code>
prop.</li>
<li>If the response is unsuccessful, an error is returned by <code>getServerSideProps</code> and is available to the page via the
<code>error</code> prop.</li>
</ul>
<p>☝️ If there is an <code>error</code> I return early and display the error using an HTML <code>&lt;pre&gt;</code> element.</p>
<p>😊 If there is <code>data</code> then I return as planned, and using another HTML <code>&lt;pre&gt;</code> element show the data retrieved from the
database.</p>
<h3 id="serverless-function---insert">Serverless Function - Insert</h3>
<p>The insert function works a little differently and is made up of two separate parts.</p>
<ul>
<li>Serverless Function created in <code>/pages/api/</code>.</li>
<li>Client side <code>fetch</code> used inside the page.</li>
</ul>
<p>To create the Serverless Function make a new directory in <code>pages</code> called <code>api</code>. Then inside the <code>api</code> directory create a
new file called <code>insert-location.js</code> and add the following code snippet.</p>
<pre class="language-javascript"><code is:raw="" class="language-javascript"><span class="token comment">// pages/api/insert-location.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> client <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../../db&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> requestIp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;request-ip&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> geoip <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fast-geoip&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> date <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ip <span class="token operator">=</span> <span class="token keyword">await</span> requestIp<span class="token punctuation">.</span><span class="token function">getClientIp</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> geo <span class="token operator">=</span> <span class="token keyword">await</span> geoip<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> city <span class="token operator">=</span> geo <span class="token operator">?</span> geo<span class="token punctuation">.</span>city <span class="token operator">:</span> <span class="token string">&#39;Greenland&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lat <span class="token operator">=</span> geo <span class="token operator">?</span> geo<span class="token punctuation">.</span>ll<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token number">65.95346100241352</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lng <span class="token operator">=</span> geo <span class="token operator">?</span> geo<span class="token punctuation">.</span>ll<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">44.96798528799432</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span>
      <span class="token string">&#39;INSERT INTO locations (date, city, lat, lng, runtime) VALUES(${date}, ${city}, ${lat}, ${lng}, ${serverless}) RETURNING id&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">date</span><span class="token operator">:</span> date<span class="token punctuation">,</span>
        <span class="token literal-property property">city</span><span class="token operator">:</span> city<span class="token punctuation">,</span>
        <span class="token literal-property property">lat</span><span class="token operator">:</span> lat<span class="token punctuation">,</span>
        <span class="token literal-property property">lng</span><span class="token operator">:</span> lng<span class="token punctuation">,</span>
        <span class="token literal-property property">serverless</span><span class="token operator">:</span> <span class="token string">&#39;serverless&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;A-OK!&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> response<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token literal-property property">city</span><span class="token operator">:</span> city<span class="token punctuation">,</span>
        <span class="token literal-property property">date</span><span class="token operator">:</span> date<span class="token punctuation">,</span>
        <span class="token literal-property property">lat</span><span class="token operator">:</span> lat<span class="token punctuation">,</span>
        <span class="token literal-property property">lng</span><span class="token operator">:</span> lng<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Once again there’s quite a lot going on in here so I’ll talk you through it.</p>
<p>As before, you’ll need to <code>require</code> the <code>client</code> function along with two of the dependencies installed earlier.
<code>requestIp</code> and <code>geoip</code> are used to convert the IP address from the <code>req</code> object into a real geographical location.</p>
<p>☝️ However, when running this on <code>http://localhost:3000/</code> there won’t be an IP address so there’s x3 ternary conditions
to catch <code>null</code> values. When running this locally the function will return details for Greenland.</p>
<p>The date is taken from the <code>req.body</code>, this ensures the date comes from the timezone of the user’s browser, not the
timezone of wherever the Serverless Function has been deployed on the Vercel (AWS) network.</p>
<p>These geographical locations and the date are then inserted into the database using <code>db.one</code> from pg-promise, the query
itself is standard SQL syntax. The only key part I’d like to ensure you notice is where it says <code>RETURNING id</code>. This
ensures the response actually returns the <code>id</code> after the row has been inserted into the table.</p>
<p>Following on from that I’m using <code>res.status(200)</code> chained with <code>.json({})</code> to send the <code>id</code> and the other values
created by the function back to the client. You probably won’t need these, but if you want to use a <code>console.log()</code> in
the <code>fetch</code> request, (which I’ll explain next), you’d see what’s been inserted into the database table.</p>
<h3 id="fetch---insert">fetch - Insert</h3>
<pre class="language-diff"><code is:raw="" class="language-diff">// pages/index.js
import React from &#39;react&#39;;

const Page = ({ data, error }) =&gt; {

<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  const handleInsert = async () =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">    try {
</span><span class="token prefix inserted">+</span><span class="token line">      const response = await fetch(&#39;/api/insert-location&#39;, {
</span><span class="token prefix inserted">+</span><span class="token line">        method: &#39;POST&#39;,
</span><span class="token prefix inserted">+</span><span class="token line">        body: JSON.stringify({
</span><span class="token prefix inserted">+</span><span class="token line">          date: new Date(),
</span><span class="token prefix inserted">+</span><span class="token line">        }),
</span><span class="token prefix inserted">+</span><span class="token line">      });
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      const json = await response.json();
</span><span class="token prefix inserted">+</span><span class="token line">      console.log(json);
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      if (!response.ok) {
</span><span class="token prefix inserted">+</span><span class="token line">        throw new Error(json.message);
</span><span class="token prefix inserted">+</span><span class="token line">      }
</span><span class="token prefix inserted">+</span><span class="token line">    } catch (error) {
</span><span class="token prefix inserted">+</span><span class="token line">      console.error(error.message);
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span><span class="token prefix inserted">+</span><span class="token line">  };
</span></span>

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> if (error) {
</span><span class="token prefix unchanged"> </span><span class="token line">   ...
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return (
</span><span class="token prefix unchanged"> </span><span class="token line">   &lt;main style={{ fontFamily: &#39;system-ui&#39; }}&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     &lt;h1&gt;Getting Started With CockroachDB, pg-promise and Next.js&lt;/h1&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     &lt;h2&gt;Insert&lt;/h2&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     &lt;p&gt;Click submit to insert a new location&lt;/p&gt;
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">     &lt;button onClick={() =&gt; {}}&gt;Submit&lt;/button&gt;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     &lt;button onClick={handleInsert}&gt;Submit&lt;/button&gt;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     &lt;h2&gt;Data&lt;/h2&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     &lt;pre&gt;{JSON.stringify(data, null, 2)}&lt;/pre&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">   &lt;/main&gt;
</span><span class="token prefix unchanged"> </span><span class="token line"> );
</span></span>};

export const getServerSideProps = async () =&gt; {
...
};

export default Page;</code></pre>
<p>This is a client-side HTTP fetch request with the method of <code>POST</code>. The request sends the date on the <code>body</code> ready to be
used in the Serverless Function. You can see the response in your browser because I’ve added <code>console.log(json)</code>. You
might want to remove this for production.</p>
<p>It’s worth noting that you won’t see the page refresh when the response comes back. If you manually refresh the page you
will see all the current rows in the locations table, but hang in there. There’s a special Next.js <em>trick</em> we can use to
refresh the page after the response comes back.</p>
<h3 id="serverless-function---delete">Serverless Function - Delete</h3>
<p>The delete function is similar to the insert function but a little simpler, it is also made up of to separate parts.</p>
<ul>
<li>Serverless Function created in <code>/pages/api/</code>.</li>
<li>Client side <code>fetch</code> used inside the page.</li>
</ul>
<p>To create the Serverless Function make a new file called <code>delete-location.js</code> inside the <code>api</code> directory and add the
following code snippet.</p>
<pre class="language-javascript"><code is:raw="" class="language-javascript"><span class="token comment">// pages/api/delete-location.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> client <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../../db&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">none</span><span class="token punctuation">(</span><span class="token string">&#39;DELETE FROM locations WHERE id = $1&#39;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;A-OK!&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>As promised this function is simpler. This time the <code>id</code> is taken from the <code>req.body</code> and is used to delete a row from
the locations table in the database using <code>db.none</code>. There’s no need to return anything using SQL this time and all I’m
doing is returning the <code>id</code> back to the client so you can add <code>console.log(json)</code> and confirm the <code>id</code> that was sent was
the <code>id</code> that was deleted.</p>
<h3 id="fetch---delete">fetch - Delete</h3>
<pre class="language-diff"><code is:raw="" class="language-diff">// pages/index.js

import React from &#39;react&#39;;

const Page = ({ data, error }) =&gt; {

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const handleInsert = async () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   ...
</span><span class="token prefix unchanged"> </span><span class="token line"> };
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  const handleDelete = async (id) =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">    try {
</span><span class="token prefix inserted">+</span><span class="token line">      const response = await fetch(&#39;/api/delete-location&#39;, {
</span><span class="token prefix inserted">+</span><span class="token line">        method: &#39;POST&#39;,
</span><span class="token prefix inserted">+</span><span class="token line">        body: JSON.stringify({
</span><span class="token prefix inserted">+</span><span class="token line">          id: id,
</span><span class="token prefix inserted">+</span><span class="token line">        }),
</span><span class="token prefix inserted">+</span><span class="token line">      });
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      const json = await response.json();
</span><span class="token prefix inserted">+</span><span class="token line">      console.log(json);
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      if (!response.ok) {
</span><span class="token prefix inserted">+</span><span class="token line">        throw new Error(json.message);
</span><span class="token prefix inserted">+</span><span class="token line">      }
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    } catch (error) {
</span><span class="token prefix inserted">+</span><span class="token line">      console.error(error.message);
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span><span class="token prefix inserted">+</span><span class="token line">  };
</span></span>

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> if (error) {
</span><span class="token prefix unchanged"> </span><span class="token line">   ...
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return (
</span><span class="token prefix unchanged"> </span><span class="token line">   &lt;main style={{ fontFamily: &#39;system-ui&#39; }}&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     &lt;h1&gt;Getting Started With CockroachDB, pg-promise and Next.js&lt;/h1&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     &lt;h2&gt;Insert&lt;/h2&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     &lt;p&gt;Click submit to insert a new location&lt;/p&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     &lt;button onClick={handleInsert}&gt;Submit&lt;/button&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     &lt;h2&gt;Data&lt;/h2&gt;
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">      &lt;pre&gt;{JSON.stringify(data, null, 2)}&lt;/pre&gt;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      {data.locations.map((l, i) =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">        const { id, date, city, lat, lng, runtime } = l;
</span><span class="token prefix inserted">+</span><span class="token line">        return (
</span><span class="token prefix inserted">+</span><span class="token line">          &lt;dl key={i}&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dt&gt;Id&lt;/dt&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dd&gt;
</span><span class="token prefix inserted">+</span><span class="token line">              &lt;span&gt;{id}&lt;/span&gt; &lt;button onClick={() =&gt; handleDelete(id)}&gt;delete&lt;/button&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;/dd&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dt&gt;Date&lt;/dt&gt;
</span><span class="token prefix inserted">+</span><span class="token line">             &lt;dd&gt;{new Date(date).toDateString()}&lt;/dd&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dt&gt;City&lt;/dt&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dd&gt;{city}&lt;/dd&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dt&gt;Latitude&lt;/dt&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dd&gt;{lat}&lt;/dd&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dt&gt;Longitude&lt;/dt&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dd&gt;{lng}&lt;/dd&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dt&gt;Runtime&lt;/dt&gt;
</span><span class="token prefix inserted">+</span><span class="token line">            &lt;dd&gt;{runtime}&lt;/dd&gt;
</span><span class="token prefix inserted">+</span><span class="token line">          &lt;/dl&gt;
</span><span class="token prefix inserted">+</span><span class="token line">        );
</span><span class="token prefix inserted">+</span><span class="token line">      })}
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   &lt;/main&gt;
</span><span class="token prefix unchanged"> </span><span class="token line"> );
</span></span>};

export const getServerSideProps = async () =&gt; {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">...
</span></span>};

export default Page;</code></pre>
<h3 id="final-touches">Final Touches</h3>
<p>As mentioned earlier when you insert or delete, the page doesn’t update to show the data. Only when you manually refresh
will you notice a difference. Let’s fix that!</p>
<p>The reason the page doesn’t update is because it’s Server-side rendered and doesn’t know about any updates that have
happened as a result of any client-side fetch requests. To remedy this you can call a <code>refreshData()</code> after both the
insert and delete requests come back from the Serverless Function. It works like this.</p>
<pre class="language-diff"><code is:raw="" class="language-diff">// pages/index.js

import React from &#39;react&#39;;
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> import { useRouter } from &#39;next/router&#39;;
</span></span>

const Page = ({ data, error }) =&gt; {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  const router = useRouter();
</span></span>

<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  const refreshData = () =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">    router.replace(router.asPath, undefined, { scroll: false });
</span><span class="token prefix inserted">+</span><span class="token line">  };
</span></span>

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const handleInsert = async () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   try {
</span><span class="token prefix unchanged"> </span><span class="token line">     const response = await fetch(&#39;/api/insert-location&#39;, {
</span><span class="token prefix unchanged"> </span><span class="token line">       method: &#39;POST&#39;,
</span><span class="token prefix unchanged"> </span><span class="token line">       body: JSON.stringify({
</span><span class="token prefix unchanged"> </span><span class="token line">         date: new Date(),
</span><span class="token prefix unchanged"> </span><span class="token line">       }),
</span><span class="token prefix unchanged"> </span><span class="token line">     });
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     const json = await response.json();
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      refreshData();
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     console.log(json);
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     if (!response.ok) {
</span><span class="token prefix unchanged"> </span><span class="token line">       throw new Error(json.message);
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">   } catch (error) {
</span><span class="token prefix unchanged"> </span><span class="token line">     console.error(error.message);
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> };
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const handleDelete = async (id) =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   try {
</span><span class="token prefix unchanged"> </span><span class="token line">     const response = await fetch(&#39;/api/delete-location&#39;, {
</span><span class="token prefix unchanged"> </span><span class="token line">       method: &#39;POST&#39;,
</span><span class="token prefix unchanged"> </span><span class="token line">       body: JSON.stringify({
</span><span class="token prefix unchanged"> </span><span class="token line">         id: id,
</span><span class="token prefix unchanged"> </span><span class="token line">       }),
</span><span class="token prefix unchanged"> </span><span class="token line">     });
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     const json = await response.json();
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      refreshData();
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     console.log(json);
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     if (!response.ok) {
</span><span class="token prefix unchanged"> </span><span class="token line">       throw new Error(json.message);
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">   } catch (error) {
</span><span class="token prefix unchanged"> </span><span class="token line">     console.error(error.message);
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> };
</span></span>

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> if (error) {
</span><span class="token prefix unchanged"> </span><span class="token line">   ....
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return (
</span><span class="token prefix unchanged"> </span><span class="token line">   &lt;main style={{ fontFamily: &#39;system-ui&#39; }}&gt;
</span><span class="token prefix unchanged"> </span><span class="token line">     ...
</span><span class="token prefix unchanged"> </span><span class="token line">   &lt;/main&gt;
</span><span class="token prefix unchanged"> </span><span class="token line"> );
</span></span>};


export const getServerSideProps = async () =&gt; {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">...
</span></span>};

export default Page;
</code></pre>
<h2 id="deploying-to-vercel">Deploying to Vercel</h2>
<p>I’m not going to walk you through this as its been really well documented in the
<a href="https://vercel.com/docs/frameworks/nextjs">Vercel docs</a>. All I’d like to mention is this. Earlier I mentioned creating
two different Clusters, one for development (<strong>dev-</strong>), one for production (<strong>prod-</strong>). Use the production connection
string when adding the environment variable to you Vercel Project.</p>
<h2 id="finished">Finished</h2>
<p>This has been quite a journey and I hope you’ve ended up with something not to dissimilar to my sample app. If you spot
any mistakes, or think there are areas that could be expanded on, please feel free to leave a comment or come and find
me on Twitter: <a href="https://twitter.com/PaulieScanlon">@PaulieScanlon</a>.</p><aside class="fixed top-[4.6rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[19.5rem] py-6 px-8 overflow-y-auto hidden xl:flex flex-col gap-8 z-10"><div class="grid gap-4 rounded border border-brand-outline bg-brand-surface/50 px-4 sm:px-6 py-6"><div class="rounded shadow-lg overflow-hidden w-full"><img src="https://res.cloudinary.com/www-paulie-dev/image/upload/v1677502114/paulie.dev/2023/02/open-graph-image_qkecxd.jpg" alt="Getting Started With CockroachDB, pg-promise and Next.js" class="m-0" width="240" height="135" loading="lazy" decoding="async"></div><a href="https://twitter.com/intent/tweet?text=Getting Started With CockroachDB, pg-promise and Next.js
 https://paulie.dev/posts/2023/02/getting-started-with-cockroachdb-pg-promise-and-nextjs/" target="_blank" rel="noreferrer" class="not-prose flex items-center justify-center gap-4 no-underline text-brand-secondary text-sm text-center py-2 px-4 transition-all duration-300 rounded border border-brand-outline bg-brand-surface hover:text-brand-text hover:bg-brand-muted/20"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg>
Share on X
</a></div><div class="px-2"><h5 class="font-semibold uppercase text-brand-secondary">on this page</h5><ul class="list-none m-0 p-0"><li class="m-0 py-0 pl-4"><a href="#getting-started-resources" class="text-xs p-1 no-underline text-violet-300">Getting Started Resources</a></li><li class="m-0 py-0 pl-4"><a href="#modern-frontends" class="text-xs p-1 no-underline text-violet-300">Modern FrontEnds</a></li><li class="m-0 py-0 pl-6"><a href="#sql--pg-promise" class="text-xs p-1 no-underline text-violet-300">SQL / pg-promise</a></li><li class="m-0 py-0 pl-6"><a href="#cockroach-sql" class="text-xs p-1 no-underline text-violet-300">cockroach sql</a></li><li class="m-0 py-0 pl-4"><a href="#getting-started-with-cockroachdb" class="text-xs p-1 no-underline text-violet-300">Getting Started With CockroachDB</a></li><li class="m-0 py-0 pl-6"><a href="#create-a-cockroachdb-cluster" class="text-xs p-1 no-underline text-violet-300">Create a CockroachDB Cluster</a></li><li class="m-0 py-0 pl-6"><a href="#setup-a-cockroachdb-cluster---1" class="text-xs p-1 no-underline text-violet-300">Setup a CockroachDB Cluster - 1</a></li><li class="m-0 py-0 pl-6"><a href="#setup-a-cockroachdb-cluster---2" class="text-xs p-1 no-underline text-violet-300">Setup a CockroachDB Cluster - 2</a></li><li class="m-0 py-0 pl-6"><a href="#create-sql-user---name" class="text-xs p-1 no-underline text-violet-300">Create SQL User - name</a></li><li class="m-0 py-0 pl-6"><a href="#create-sql-user---password" class="text-xs p-1 no-underline text-violet-300">Create SQL User - password</a></li><li class="m-0 py-0 pl-6"><a href="#create-sql-user---database_url" class="text-xs p-1 no-underline text-violet-300">Create SQL User - DATABASE_URL</a></li><li class="m-0 py-0 pl-6"><a href="#repeat-for-production" class="text-xs p-1 no-underline text-violet-300">Repeat For Production</a></li><li class="m-0 py-0 pl-6"><a href="#cluster-overview" class="text-xs p-1 no-underline text-violet-300">Cluster Overview</a></li><li class="m-0 py-0 pl-6"><a href="#connecting-to-a-cluster-with-cockroach-sql" class="text-xs p-1 no-underline text-violet-300">Connecting to a Cluster with cockroach sql</a></li><li class="m-0 py-0 pl-6"><a href="#creating-a-table-with-cockroach-sql" class="text-xs p-1 no-underline text-violet-300">Creating a table with cockroach sql</a></li><li class="m-0 py-0 pl-4"><a href="#getting-started-with-pg-promise-and-nextjs" class="text-xs p-1 no-underline text-violet-300">Getting Started With pg-promise and Next.js</a></li><li class="m-0 py-0 pl-6"><a href="#create-an-empty-github-repository" class="text-xs p-1 no-underline text-violet-300">Create an Empty GitHub Repository</a></li><li class="m-0 py-0 pl-6"><a href="#install-dependencies" class="text-xs p-1 no-underline text-violet-300">Install Dependencies</a></li><li class="m-0 py-0 pl-6"><a href="#add-scripts" class="text-xs p-1 no-underline text-violet-300">Add Scripts</a></li><li class="m-0 py-0 pl-6"><a href="#environment-variables" class="text-xs p-1 no-underline text-violet-300">Environment Variables</a></li><li class="m-0 py-0 pl-6"><a href="#pg-promise-config" class="text-xs p-1 no-underline text-violet-300">pg-promise config</a></li><li class="m-0 py-0 pl-6"><a href="#create-a-page" class="text-xs p-1 no-underline text-violet-300">Create A Page</a></li><li class="m-0 py-0 pl-8"><a href="#query" class="text-xs p-1 no-underline text-violet-300">Query</a></li><li class="m-0 py-0 pl-8"><a href="#mutation" class="text-xs p-1 no-underline text-violet-300">Mutation</a></li><li class="m-0 py-0 pl-6"><a href="#serverless-function---insert" class="text-xs p-1 no-underline text-violet-300">Serverless Function - Insert</a></li><li class="m-0 py-0 pl-6"><a href="#fetch---insert" class="text-xs p-1 no-underline text-violet-300">fetch - Insert</a></li><li class="m-0 py-0 pl-6"><a href="#serverless-function---delete" class="text-xs p-1 no-underline text-violet-300">Serverless Function - Delete</a></li><li class="m-0 py-0 pl-6"><a href="#fetch---delete" class="text-xs p-1 no-underline text-violet-300">fetch - Delete</a></li><li class="m-0 py-0 pl-6"><a href="#final-touches" class="text-xs p-1 no-underline text-violet-300">Final Touches</a></li><li class="m-0 py-0 pl-4"><a href="#deploying-to-vercel" class="text-xs p-1 no-underline text-violet-300">Deploying to Vercel</a></li><li class="m-0 py-0 pl-4"><a href="#finished" class="text-xs p-1 no-underline text-violet-300">Finished</a></li></ul></div></aside></article></section></main></div></div></body></html>